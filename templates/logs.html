{% extends "base.html" %}

{% block title %}Logs - OCI Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white mb-1">Logs</h1>
            <p class="text-dark-400">Real-time bot activity logs</p>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="clearLogs()" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-dark-800 border border-dark-700 hover:border-danger/50 text-dark-300 hover:text-danger transition-all">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                <span>Clear</span>
            </button>
            <button onclick="toggleAutoScroll()" id="auto-scroll-btn" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-accent-primary/20 border border-accent-primary/30 text-accent-primary transition-all">
                <i data-lucide="arrow-down-circle" class="w-4 h-4"></i>
                <span>Auto-scroll: ON</span>
            </button>
        </div>
    </div>
    
    <!-- Log Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="glass rounded-xl p-4 flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-info/20 flex items-center justify-center">
                <i data-lucide="info" class="w-5 h-5 text-info"></i>
            </div>
            <div>
                <p class="text-xs text-dark-400">Info</p>
                <p class="text-xl font-bold text-white" id="info-count">0</p>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-warning/20 flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-warning"></i>
            </div>
            <div>
                <p class="text-xs text-dark-400">Warnings</p>
                <p class="text-xl font-bold text-white" id="warning-count">0</p>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-danger/20 flex items-center justify-center">
                <i data-lucide="x-circle" class="w-5 h-5 text-danger"></i>
            </div>
            <div>
                <p class="text-xs text-dark-400">Errors</p>
                <p class="text-xl font-bold text-white" id="error-count">0</p>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-success/20 flex items-center justify-center">
                <i data-lucide="check-circle" class="w-5 h-5 text-success"></i>
            </div>
            <div>
                <p class="text-xs text-dark-400">Success</p>
                <p class="text-xl font-bold text-white" id="success-count">0</p>
            </div>
        </div>
    </div>
    
    <!-- Filter -->
    <div class="glass rounded-xl p-4">
        <div class="flex flex-wrap items-center gap-4">
            <span class="text-sm text-dark-400">Filter:</span>
            <button onclick="filterLogs('all')" class="log-filter active px-4 py-2 rounded-lg text-sm font-medium transition-all" data-filter="all">
                All
            </button>
            <button onclick="filterLogs('INFO')" class="log-filter px-4 py-2 rounded-lg text-sm font-medium transition-all" data-filter="INFO">
                Info
            </button>
            <button onclick="filterLogs('WARNING')" class="log-filter px-4 py-2 rounded-lg text-sm font-medium transition-all" data-filter="WARNING">
                Warning
            </button>
            <button onclick="filterLogs('ERROR')" class="log-filter px-4 py-2 rounded-lg text-sm font-medium transition-all" data-filter="ERROR">
                Error
            </button>
            
            <div class="flex-1"></div>
            
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-dark-500"></i>
                <input 
                    type="text" 
                    id="log-search" 
                    placeholder="Search logs..." 
                    onkeyup="searchLogs(this.value)"
                    class="bg-dark-800/50 border border-dark-600 rounded-lg py-2 pl-10 pr-4 text-sm text-white placeholder-dark-500 w-64"
                >
            </div>
        </div>
    </div>
    
    <!-- Log Terminal -->
    <div class="glass rounded-2xl overflow-hidden">
        <div class="p-4 border-b border-dark-700/50 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="flex gap-2">
                    <span class="w-3 h-3 rounded-full bg-danger"></span>
                    <span class="w-3 h-3 rounded-full bg-warning"></span>
                    <span class="w-3 h-3 rounded-full bg-success"></span>
                </div>
                <span class="text-sm text-dark-400">Terminal</span>
            </div>
            <div class="flex items-center gap-2 text-xs text-dark-500">
                <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                <span>Live</span>
            </div>
        </div>
        
        <div id="log-container" class="log-terminal bg-dark-950 p-4 h-[calc(100vh-420px)] overflow-y-auto" style="min-height: 400px;">
            <div class="text-dark-500 text-center py-12">
                <i data-lucide="terminal" class="w-12 h-12 mx-auto mb-4"></i>
                <p>Waiting for logs...</p>
            </div>
        </div>
    </div>
</div>

<style>
    .log-filter {
        background: rgba(30, 41, 59, 0.5);
        color: #94a3b8;
    }
    .log-filter:hover {
        background: rgba(51, 65, 85, 0.5);
        color: #f1f5f9;
    }
    .log-filter.active {
        background: rgba(249, 115, 22, 0.2);
        color: #f97316;
        border: 1px solid rgba(249, 115, 22, 0.3);
    }
    
    .log-entry {
        animation: fadeIn 0.2s ease-out;
    }
    
    .log-entry.hidden {
        display: none;
    }
    
    .log-highlight {
        background: rgba(249, 115, 22, 0.2);
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let autoScroll = true;
    let allLogs = [];
    let currentFilter = 'all';
    let searchQuery = '';
    
    const logCounts = {
        INFO: 0,
        WARNING: 0,
        ERROR: 0,
        CRITICAL: 0,
        SUCCESS: 0
    };
    
    // Toggle auto-scroll
    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const btn = document.getElementById('auto-scroll-btn');
        
        if (autoScroll) {
            btn.innerHTML = `
                <i data-lucide="arrow-down-circle" class="w-4 h-4"></i>
                <span>Auto-scroll: ON</span>
            `;
            btn.className = 'flex items-center gap-2 px-4 py-2 rounded-xl bg-accent-primary/20 border border-accent-primary/30 text-accent-primary transition-all';
            scrollToBottom();
        } else {
            btn.innerHTML = `
                <i data-lucide="pause-circle" class="w-4 h-4"></i>
                <span>Auto-scroll: OFF</span>
            `;
            btn.className = 'flex items-center gap-2 px-4 py-2 rounded-xl bg-dark-800 border border-dark-700 text-dark-400 transition-all';
        }
        
        lucide.createIcons();
    }
    
    // Scroll to bottom
    function scrollToBottom() {
        const container = document.getElementById('log-container');
        container.scrollTop = container.scrollHeight;
    }
    
    // Clear logs
    function clearLogs() {
        allLogs = [];
        logCounts.INFO = 0;
        logCounts.WARNING = 0;
        logCounts.ERROR = 0;
        logCounts.CRITICAL = 0;
        logCounts.SUCCESS = 0;
        
        updateLogCounts();
        renderLogs();
    }
    
    // Filter logs
    function filterLogs(filter) {
        currentFilter = filter;
        
        document.querySelectorAll('.log-filter').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filter) {
                btn.classList.add('active');
            }
        });
        
        renderLogs();
    }
    
    // Search logs
    function searchLogs(query) {
        searchQuery = query.toLowerCase();
        renderLogs();
    }
    
    // Render logs
    function renderLogs() {
        const container = document.getElementById('log-container');
        
        const filteredLogs = allLogs.filter(log => {
            // Filter by level
            if (currentFilter !== 'all' && log.level !== currentFilter) {
                return false;
            }
            
            // Filter by search
            if (searchQuery && !log.message.toLowerCase().includes(searchQuery)) {
                return false;
            }
            
            return true;
        });
        
        if (filteredLogs.length === 0) {
            container.innerHTML = `
                <div class="text-dark-500 text-center py-12">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i>
                    <p>${allLogs.length === 0 ? 'Waiting for logs...' : 'No matching logs'}</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }
        
        container.innerHTML = filteredLogs.map(log => formatLogEntry(log)).join('');
        
        if (autoScroll) {
            scrollToBottom();
        }
    }
    
    // Format log entry
    function formatLogEntry(log) {
        const levelColors = {
            'INFO': 'text-info',
            'WARNING': 'text-warning',
            'ERROR': 'text-danger',
            'CRITICAL': 'text-danger font-bold',
            'DEBUG': 'text-dark-400'
        };
        
        const levelIcons = {
            'INFO': 'info',
            'WARNING': 'alert-triangle',
            'ERROR': 'x-circle',
            'CRITICAL': 'alert-octagon',
            'DEBUG': 'bug'
        };
        
        const color = levelColors[log.level] || 'text-dark-300';
        const icon = levelIcons[log.level] || 'terminal';
        
        // Highlight search term
        let message = log.message;
        if (searchQuery) {
            const regex = new RegExp(`(${searchQuery})`, 'gi');
            message = message.replace(regex, '<span class="log-highlight">$1</span>');
        }
        
        // Check for success in message
        const isSuccess = message.toLowerCase().includes('success') || message.includes('✅');
        
        return `
            <div class="log-entry flex items-start gap-3 py-2 px-2 hover:bg-dark-800/30 rounded ${isSuccess ? 'border-l-2 border-success' : ''}">
                <span class="text-dark-600 text-xs flex-shrink-0 w-36">${log.timestamp}</span>
                <span class="flex-shrink-0 w-20">
                    <span class="inline-flex items-center gap-1 ${color} text-xs font-medium">
                        <i data-lucide="${icon}" class="w-3 h-3"></i>
                        ${log.level}
                    </span>
                </span>
                <span class="${color} flex-1 break-all">${message}</span>
            </div>
        `;
    }
    
    // Update log counts
    function updateLogCounts() {
        document.getElementById('info-count').textContent = logCounts.INFO;
        document.getElementById('warning-count').textContent = logCounts.WARNING;
        document.getElementById('error-count').textContent = logCounts.ERROR + logCounts.CRITICAL;
        document.getElementById('success-count').textContent = logCounts.SUCCESS;
    }
    
    // Add new log
    function addLog(log) {
        allLogs.push(log);
        
        // Update counts
        if (logCounts.hasOwnProperty(log.level)) {
            logCounts[log.level]++;
        }
        
        // Check for success
        if (log.message.toLowerCase().includes('success') || log.message.includes('✅')) {
            logCounts.SUCCESS++;
        }
        
        updateLogCounts();
        
        // Keep max logs
        if (allLogs.length > 1000) {
            allLogs.shift();
        }
        
        renderLogs();
    }
    
    // Load initial logs
    async function loadInitialLogs() {
        try {
            const response = await fetch('/api/logs');
            const logs = await response.json();
            
            logs.forEach(log => {
                allLogs.push(log);
                if (logCounts.hasOwnProperty(log.level)) {
                    logCounts[log.level]++;
                }
                if (log.message.toLowerCase().includes('success') || log.message.includes('✅')) {
                    logCounts.SUCCESS++;
                }
            });
            
            updateLogCounts();
            renderLogs();
        } catch (error) {
            console.error('Failed to load logs:', error);
        }
    }
    
    // WebSocket handlers
    socket.on('log_history', (logs) => {
        logs.forEach(log => {
            allLogs.push(log);
            if (logCounts.hasOwnProperty(log.level)) {
                logCounts[log.level]++;
            }
            if (log.message.toLowerCase().includes('success') || log.message.includes('✅')) {
                logCounts.SUCCESS++;
            }
        });
        updateLogCounts();
        renderLogs();
    });
    
    socket.on('log_message', (log) => {
        addLog(log);
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadInitialLogs();
        lucide.createIcons();
    });
</script>
{% endblock %}
